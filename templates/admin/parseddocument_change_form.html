{% extends "admin/change_form.html" %}

{% block extrahead %}
    {{ block.super }}
    <!-- Scripts for Live Preview Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* Smooth out the inline container so it looks like it belongs IN the fieldset */
        #images-group { 
            border: none; 
            box-shadow: none; 
            margin: 0; 
            padding: 0; 
        }
        #images-group h2 { display: none; } /* Hide the duplicate "Document Images" header if it's inside another box */
    </style>
    <script>
        window.onload = function() {
            if (typeof django !== 'undefined' && django.jQuery) {
                (function($) {
                    var imagesInline = $('#images-group');
                    var aiDataSourcesFieldset = $('h2:contains("AI Data Sources")').closest('fieldset');
                    
                    if (imagesInline.length && aiDataSourcesFieldset.length) {
                        imagesInline.appendTo(aiDataSourcesFieldset);
                    }

                    // --- UI COMPONENTS ---
                    var previewHtml = `
                    <div id="admin-live-preview-container" style="margin-top:20px; padding-top:20px; border-top:1px dashed #444; clear:both;">
                        <h3 style="margin-bottom:15px; color:#10b981; font-weight:bold; text-transform:uppercase; font-size:12px;">✅ Live Render Preview</h3>
                        <div id="admin-live-preview" style="background:#1e1e24; padding:20px; border-radius:8px; border:1px solid #333; color:#e2e8f0; max-height: 500px; overflow-y:auto; overflow-x:hidden;">
                            <em>Preview will render here automatically when valid JSON is detected...</em>
                        </div>
                    </div>`;

                    var progressOverlayHtml = `
                    <div id="ai-global-progress-overlay" style="display:none; position:fixed; top:20px; right:20px; z-index:9999; width:350px; background:#0f172a; border:1px solid #312e81; border-radius:12px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); padding:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div style="display:flex; align-items:center;">
                                <div class="pulse-ring" style="width:10px; height:10px; border-radius:50%; background:#818cf8; margin-right:10px;"></div>
                                <span style="color:#f8fafc; font-weight:700; font-size:12px; text-transform:uppercase;">AI ENGINE Status</span>
                            </div>
                            <button id="close-progress-overlay" style="background:transparent; border:none; color:#94a3b8; cursor:pointer; font-size:18px; line-height:1;">&times;</button>
                        </div>
                        <div id="ai-parsing-progress-container">
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                <span style="color:#94a3b8; font-size:11px;">Extracting Content</span>
                                <span id="parsing-progress-steps" style="color:#818cf8; font-weight:bold; font-size:11px;">0 / 0</span>
                            </div>
                            <div style="width:100%; background:#1e293b; height:6px; border-radius:3px; overflow:hidden;">
                                <div id="parsing-progress-bar" style="width:0%; height:100%; background:linear-gradient(90deg, #4f46e5, #818cf8); transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                        <div id="ai-recreation-progress-container" style="display:none; margin-top:12px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                <span style="color:#94a3b8; font-size:11px;">Recreating Diagrams</span>
                                <span id="recreation-progress-steps" style="color:#f59e0b; font-weight:bold; font-size:11px;">0 / 0</span>
                            </div>
                            <div style="width:100%; background:#1e293b; height:6px; border-radius:3px; overflow:hidden;">
                                <div id="recreation-progress-bar" style="width:0%; height:100%; background:linear-gradient(90deg, #d97706, #f59e0b); transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                        <p id="parsing-detail-text" style="margin-top:10px; color:#64748b; font-size:10px; font-style:italic;">Processing document...</p>
                    </div>
                    <style>
                        @keyframes pulse {
                            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(129, 140, 248, 0.7); }
                            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(129, 140, 248, 0); }
                            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(129, 140, 248, 0); }
                        }
                        .pulse-ring { animation: pulse 2s infinite; }
                    </style>`;
                    
                    $('.field-structured_data').append(previewHtml);
                    $('body').append(progressOverlayHtml);
                    $('#close-progress-overlay').click(() => $('#ai-global-progress-overlay').fadeOut());

                    // --- PREVIEW RENDERER ---
                    function renderAdminPreview() {
                        try {
                            const rawJson = $('#id_structured_data').val();
                            if(!rawJson || rawJson.trim() === 'null') {
                                $('#admin-live-preview').html('<em>No structured data generated yet.</em>');
                                return;
                            }
                            const data = JSON.parse(rawJson);
                            const docType = $('#id_document_type').val();
                            let html = '';

                            const renderRecreationBox = (strategy, details, url) => {
                                if (!strategy || !details) return '';
                                let color = strategy === 'CANVAS' ? "#f59e0b" : "#10b981";
                                return `
                                <div style="margin-top:10px; padding:10px; background:#1e1b4b; border-radius:6px; border:1px solid #312e81;">
                                    <div style="color:${color}; font-size:11px; font-weight:bold; margin-bottom:5px; text-transform:uppercase;">${strategy} RECREATION</div>
                                    <div style="font-family:monospace; font-size:11px; color:#a5b4fc; white-space:pre-wrap;">${details}</div>
                                    ${url ? `<div style="margin-top:10px; border-radius:4px; overflow:hidden; background:white;"><img src="${url}" style="width:100%; height:auto; display:block;"></div>` : ''}
                                </div>`;
                            };
                            
                            if ((docType === 'PYQ' || docType === 'UNSOLVED_PYQ') && data.questions) {
                                html += '<div style="display:flex; flex-direction:column; gap:15px;">';
                                data.questions.forEach(q => {
                                    html += `<div style="border:1px solid #333; border-radius:6px; padding:15px; background:#2d2d35;">
                                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px;">
                                            <strong style="color:#10b981;">Unit ${q.unit || '?'}</strong>
                                            <strong style="color:#e2e8f0;">${q.marks} Marks</strong>
                                        </div>
                                        <p style="font-size:14px; margin-bottom:15px;">${q.question_text}</p>
                                        ${renderRecreationBox(q.image_strategy, q.image_details, q.recreated_image_url)}
                                        ${q.latex_answer ? `<div class="math-target">${marked.parse(q.latex_answer)}</div>` : ''}
                                    </div>`;
                                });
                                html += '</div>';
                            } else if (docType === 'FORMULA' && data.formulas) {
                                html += '<div style="display:flex; flex-wrap:wrap; gap:15px;">';
                                data.formulas.forEach(f => {
                                    html += `<div style="border:1px solid #333; padding:15px; border-radius:6px; background:#2d2d35; text-align:center; flex:1; min-width:200px;">
                                        <h4 style="margin:0; color:#6366f1;">${f.name}</h4>
                                        <div class="math-target">$$ ${f.latex} $$</div>
                                    </div>`;
                                });
                                html += '</div>';
                            } else if (data.sections) {
                                data.sections.forEach(s => {
                                    let blocks = '';
                                    (s.content_blocks || []).forEach(b => {
                                        if (b.type === 'text') blocks += `<div class="math-target">${marked.parse(b.content || '')}</div>`;
                                        else blocks += renderRecreationBox(b.image_strategy, b.image_details, b.recreated_image_url);
                                    });
                                    html += `<div style="padding:15px; background:#2d2d35; border-radius:6px; border:1px solid #333; margin-bottom:15px;">
                                        <h4 style="margin:0; color:#818cf8; border-bottom:1px solid #444; padding-bottom:8px;">${s.section_title}</h4>
                                        <div style="margin-top:10px;">${blocks}</div>
                                    </div>`;
                                });
                            } else {
                                html = `<pre style="font-size:12px; color:#cbd5e1; white-space:pre-wrap;">${JSON.stringify(data, null, 2)}</pre>`;
                            }
                            
                            $('#admin-live-preview').html(html);
                            if(window.renderMathInElement) {
                                renderMathInElement(document.getElementById('admin-live-preview'), {
                                    delimiters: [
                                        {left: '$$', right: '$$', display: true},
                                        {left: '$', right: '$', display: false}
                                    ],
                                    throwOnError: false
                                });
                            }
                        } catch(e) {
                            $('#admin-live-preview').html(`<div style="color:#ef4444; font-size:11px;">❌ JSON Error: ${e.message}</div>`);
                        }
                    }

                    // --- STATUS POLLING ---
                    var docId = "{{ original.id }}";
                    var currentStatus = "{{ original.parsing_status }}";
                    
                    if (docId && (currentStatus === 'PROCESSING' || currentStatus === 'PENDING')) {
                        $('#ai-global-progress-overlay').show();
                        var pollInterval = setInterval(function() {
                            $.getJSON(`/api/document/${docId}/parsing-status/`, function(data) {
                                if (data.status === 'PROCESSING' || data.status === 'PENDING') {
                                    $('#parsing-progress-steps').text(data.completed_steps + ' / ' + data.total_steps);
                                    $('#parsing-progress-bar').css('width', (data.total_steps > 0 ? (data.completed_steps / data.total_steps * 100) : 0) + '%');
                                    $('#parsing-detail-text').text(data.status === 'PENDING' ? 'Waiting for worker...' : 'Parsing via Gemini...');
                                    
                                    if (data.recreation_total > 0) {
                                        $('#ai-recreation-progress-container').show();
                                        $('#recreation-progress-steps').text(data.recreation_completed + ' / ' + data.recreation_total);
                                        $('#recreation-progress-bar').css('width', (data.recreation_completed / data.recreation_total * 100) + '%');
                                    }
                                } else if (data.status === 'COMPLETED') {
                                    clearInterval(pollInterval);
                                    window.location.reload();
                                } else if (data.status === 'FAILED') {
                                    clearInterval(pollInterval);
                                    alert('AI Parsing failed.');
                                    window.location.reload();
                                }
                            });
                        }, 3000);
                    }

                    $('#id_structured_data').on('input propertychange', renderAdminPreview);
                    $('#id_document_type').on('change', renderAdminPreview);
                    setTimeout(renderAdminPreview, 200);

                })(django.jQuery);
            }
        };
    </script>
{% endblock %}

{% block submit_buttons_bottom %}
    <div class="submit-row" style="display: flex; align-items: center; flex-wrap: wrap;">
        {{ block.super }}
        {% if original %}
            <input type="submit" value="✨ Generate Material with AI" name="_parse_ai" class="default" style="background: #10b981; color: white; border-radius: 4px; border: none; padding: 10px 20px; font-weight: bold; margin-left: 15px; cursor: pointer; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px;">
        {% endif %}
    </div>
{% endblock %}
