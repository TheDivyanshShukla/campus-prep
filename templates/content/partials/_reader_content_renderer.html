{# Partial: _reader_content_renderer.html #}
{# Renders decrypted structured JSON content into #secure-content-container. #}
{# Supports: PYQ, UNSOLVED_PYQ, NOTES, SHORT_NOTES, FORMULA, SYLLABUS, IMPORTANT_Q. #}
{# Requires: marked.js, MathJax, window.__drm_tripped (from _reader_security.html) #}
{# Context variables used: document.document_type, document.id, encrypted_data, tamper_nonce, csrf_token, url 'api_document_key' document.id #}
<script>
    // ---------- Image Recreation Box ----------

    function renderRecreationBox(strategy, details, url) {
        if (!strategy || !details) return '';
        let bgColor = 'bg-blue-50 dark:bg-blue-900/10';
        let borderColor = 'border-blue-200 dark:border-blue-900';
        let textColor = 'text-blue-800 dark:text-blue-300';
        let iconColor = 'text-blue-500';
        let label = 'DIAGRAM';

        if (strategy === 'SEARCH') {
            bgColor = 'bg-emerald-50 dark:bg-emerald-900/10';
            borderColor = 'border-emerald-200 dark:border-emerald-900';
            textColor = 'text-emerald-800 dark:text-emerald-300';
            iconColor = 'text-emerald-500';
            label = 'Search Reference';
        } else if (strategy === 'CANVAS') {
            bgColor = 'bg-amber-50 dark:bg-amber-900/10';
            borderColor = 'border-amber-200 dark:border-amber-900';
            textColor = 'text-amber-800 dark:text-amber-300';
            iconColor = 'text-amber-500';
            label = 'Interactive Logic';
        }

        const imageHtml = url ? `<div class="mt-4 rounded-xl overflow-hidden border border-black/10 dark:border-white/10 shadow-lg bg-white">
            <img src="${url}" class="w-full h-auto block" alt="Recreated Academic Diagram" loading="lazy">
        </div>` : '';

        return `
        <div class="mt-4 p-4 border ${borderColor} ${bgColor} rounded-xl group transition-all duration-300 hover:shadow-md">
            <div class="flex items-center ${textColor} mb-3">
                <svg class="w-5 h-5 mr-2 ${iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span class="font-bold text-xs uppercase tracking-widest">${label} Detected</span>
            </div>
            <div class="text-xs font-mono p-3 leading-relaxed bg-white/50 dark:bg-black/20 rounded-lg border border-white/20 dark:border-black/10 overflow-x-auto whitespace-pre-wrap ${textColor}">${details}</div>
            ${imageHtml}
            <div class="mt-3 flex justify-end">
                <span class="text-[9px] font-black uppercase tracking-tighter opacity-40 group-hover:opacity-100 transition-opacity">AI Reconstruction Strategy: ${strategy}</span>
            </div>
        </div>`;
    }

    // ---------- Document-Type Renderers ----------

    function _renderPYQ(container, data) {
        (data.questions || []).forEach(q => {
            const unitHtml = q.unit ? `<span class="inline-block bg-primary text-primary-foreground text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">Unit ${q.unit}</span>` : '';
            const orChoiceHtml = q.has_or_choice ? `<span class="inline-block ml-2 text-xs font-bold text-amber-600 dark:text-amber-400 bg-amber-100 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 px-2 py-1 rounded">OR Choice</span>` : '';
            const partHtml = q.part ? `<span class="inline-flex items-center justify-center bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-2 py-0.5 rounded font-bold text-xs mr-2 border border-slate-200 dark:border-slate-700 uppercase">${q.part}</span>` : '';
            const imgRecreHtml = renderRecreationBox(q.image_strategy, q.image_details, q.recreated_image_url);
            const aiSolutionHtml = q.latex_answer ? `<div class="mt-6 pt-6 border-t border-border"><h4 class="text-sm font-bold text-muted-foreground uppercase tracking-wide mb-4">AI Solution</h4><div class="text-base text-foreground/90 max-w-none math-render-target leading-relaxed whitespace-pre-line markdown-body">${q.latex_answer}</div></div>` : '';
            container.insertAdjacentHTML('beforeend', `
            <div class="bg-card text-card-foreground shadow-sm rounded-xl border border-border overflow-hidden">
                <div class="bg-muted/30 px-4 py-2 border-b border-border flex justify-between items-center">
                    <div class="flex items-center">${unitHtml}${orChoiceHtml}</div>
                    <div class="flex-shrink-0 text-right ml-4">
                        <span class="text-base font-black">${q.marks || ''}</span>
                        <span class="text-[9px] text-muted-foreground font-bold uppercase tracking-wider ml-1">Marks</span>
                    </div>
                </div>
                <div class="px-4 py-3">
                    <div class="text-base leading-relaxed font-medium math-render-target whitespace-pre-line text-foreground/90">${partHtml}${q.question_text || ''}</div>
                    ${imgRecreHtml}
                    ${aiSolutionHtml}
                </div>
            </div>`);
        });
    }

    function _renderNotes(container, data) {
        if (data.sections) {
            data.sections.forEach((section, idx) => {
                let blocksHtml = '';
                (section.content_blocks || []).forEach(block => {
                    if (block.type === 'text') {
                        blocksHtml += `<div class="text-base text-foreground/90 max-w-none math-render-target leading-relaxed markdown-body">${marked.parse(block.content || '')}</div>`;
                    } else if (block.type === 'image') {
                        blocksHtml += renderRecreationBox(block.image_strategy, block.image_details, block.recreated_image_url);
                    }
                });
                container.insertAdjacentHTML('beforeend', `
                <div class="bg-card shadow-sm rounded-xl border border-border overflow-hidden mb-6">
                    <div class="bg-indigo-50 dark:bg-indigo-900/10 px-6 py-4 border-b border-border">
                        <h2 class="text-xl font-bold text-indigo-900 dark:text-indigo-200">${section.section_title || `Section ${idx + 1}`}</h2>
                    </div>
                    <div class="p-6">${blocksHtml}</div>
                </div>`);
            });
        } else {
            // Legacy single-block content fallback
            container.insertAdjacentHTML('beforeend', `
            <div class="bg-card shadow-sm rounded-xl border border-border p-6 markdown-body math-render-target">
                ${marked.parse(data.content || '')}
            </div>`);
        }
    }

    function _renderFormula(container, data) {
        if (!data.formulas) return;
        const formulasHtml = data.formulas.map(f => `
            <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-muted/20 border border-border rounded-lg hover:border-primary/50 transition-colors">
                <span class="font-semibold text-foreground mb-2 sm:mb-0">${f.name || ''}</span>
                <div class="bg-white dark:bg-slate-900 border border-border px-4 py-2 rounded-md overflow-x-auto math-render-target">$$ ${f.latex || ''} $$</div>
            </div>`).join('');
        container.insertAdjacentHTML('beforeend', `
        <div class="bg-card shadow-sm rounded-xl border border-border overflow-hidden">
            <div class="p-6"><div class="grid md:grid-cols-2 gap-4">${formulasHtml}</div></div>
        </div>`);
    }

    function _renderSyllabus(container, data) {
        if (!data.modules) return;
        const html = data.modules.map(mod => `
        <div class="bg-card shadow-sm rounded-xl border border-border overflow-hidden relative">
            <div class="absolute left-0 top-0 bottom-0 w-2 bg-indigo-500"></div>
            <div class="p-6 pl-8">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 flex items-center justify-center font-black mr-3">${mod.unit || ''}</div>
                    <h3 class="text-lg font-bold">Unit ${mod.unit || ''} Syllabus</h3>
                </div>
                <ul class="space-y-3">
                    ${(mod.topics || []).map(t => `<li class="flex items-start"><svg class="w-5 h-5 text-green-500 mr-2 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-foreground/80">${t}</span></li>`).join('')}
                </ul>
            </div>
        </div>`).join('');
        container.insertAdjacentHTML('beforeend', `<div class="space-y-6">${html}</div>`);
    }

    function _renderImportantQ(container, data) {
        if (!data.questions) return;
        const html = data.questions.map(q => {
            const freqColor = q.frequency === 'High'
                ? 'text-rose-600 bg-rose-100 border-rose-200 dark:bg-rose-900/30 dark:border-rose-800'
                : q.frequency === 'Medium'
                ? 'text-amber-600 bg-amber-100 border-amber-200 dark:bg-amber-900/30 dark:border-amber-800'
                : 'text-blue-600 bg-blue-100 border-blue-200 dark:bg-blue-900/30 dark:border-blue-800';
            return `
            <div class="p-6 border-b border-border last:border-0 hover:bg-muted/10 transition-colors flex items-start gap-4">
                <div class="shrink-0 mt-1"><svg class="w-6 h-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <div class="flex-1">
                    <div class="text-lg font-medium text-foreground/90 leading-relaxed math-render-target">${q.text || ''}</div>
                    <span class="inline-block mt-2 text-xs font-bold px-2 py-1 rounded-md border ${freqColor}">${q.frequency || ''} Frequency</span>
                </div>
            </div>`;
        }).join('');
        container.insertAdjacentHTML('beforeend', `<div class="bg-card shadow-sm rounded-xl border border-border overflow-hidden">${html}</div>`);
    }

    // ---------- Decryption + Render Engine ----------

    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(async function () {
            if (window.__drm_tripped) return;

            const docType = "{{ document.document_type|escapejs }}";
            const cipher  = "{{ encrypted_data|escapejs }}";
            const nonce   = "{{ tamper_nonce|escapejs }}";

            let structuredData = null;
            try {
                // 1. Anti-Tamper Challenge Hash
                const encoder = new TextEncoder();
                const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(nonce + 'RGPV_LIVE_SECURE_PAYLOAD'));
                const challengeHash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

                // 2. Fetch single-use decryption key
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')
                    ? document.querySelector('[name=csrfmiddlewaretoken]').value
                    : '{{ csrf_token }}';

                const response = await fetch("{% url 'api_document_key' document.id %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ challenge_hash: challengeHash })
                });
                if (!response.ok) throw new Error('Integrity check failed.');

                const hexKey = (await response.json()).key;

                // 3. XOR Decrypt
                const keyBytes = new Uint8Array(hexKey.match(/.{1,2}/g).map(b => parseInt(b, 16)));
                const decodedB64 = atob(cipher);
                const decryptedBytes = new Uint8Array(decodedB64.length);
                for (let i = 0; i < decodedB64.length; i++) {
                    decryptedBytes[i] = decodedB64.charCodeAt(i) ^ keyBytes[i % keyBytes.length];
                }
                structuredData = JSON.parse(new TextDecoder('utf-8').decode(decryptedBytes));
            } catch (e) {
                console.error('Decryption failed. Ensure the DOM has not been tampered with.');
                return;
            }

            const container = document.getElementById('secure-content-container');
            if (!container || !structuredData) return;
            container.innerHTML = '';
            container.className = 'space-y-6';

            if      (docType === 'PYQ' || docType === 'UNSOLVED_PYQ') _renderPYQ(container, structuredData);
            else if (docType === 'NOTES' || docType === 'SHORT_NOTES') _renderNotes(container, structuredData);
            else if (docType === 'FORMULA')     _renderFormula(container, structuredData);
            else if (docType === 'SYLLABUS')    _renderSyllabus(container, structuredData);
            else if (docType === 'IMPORTANT_Q') _renderImportantQ(container, structuredData);
            else container.insertAdjacentHTML('beforeend',
                `<div class="bg-card shadow-sm rounded-xl border border-border p-6 font-mono text-sm whitespace-pre-wrap overflow-x-auto">${JSON.stringify(structuredData, null, 2)}</div>`);

            // Re-render MathJax
            if (!window.__drm_tripped && window.MathJax) {
                MathJax.typesetPromise([document.body]).catch(err => console.error('MathJax error: ' + err.message));
            }
        }, 800); // Wait 800ms for DRM sweeps
    });
</script>
