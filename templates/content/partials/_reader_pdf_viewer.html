{# Partial: _reader_pdf_viewer.html #}
{# PDF.js rendering core for the standard (non-fullscreen) reader. #}
{# Context variables used: document.id, pdf_token, url 'api_secure_pdf' document.id #}
{# Requires: pdfjsLib (pdf.js CDN), window.currentZoom, collapseHeader/expandHeader, toggleSearch/closeSearch (from other partials). #}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Stop execution if security is already tripped
        if (window.__drm_tripped) return;
        
        let pageScrollTimer;

        function updateCurrentPage() {
            const canvases = document.querySelectorAll('#pdf-container canvas[id^="page-canvas-"]');
            if (!canvases.length) return;

            let closestNum = 1;
            let minDistance = Infinity;
            const viewportHalfHeight = window.innerHeight / 2;

            canvases.forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                // We want the page that is taking up the center of the viewport
                const canvasCenter = rect.top + (rect.height / 2);
                const distance = Math.abs(viewportHalfHeight - canvasCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestNum = canvas.id.split('-')[2];
                }
            });

            const inp = document.getElementById('pageNavInput');
            if (inp && inp.value != closestNum) {
                const docId = inp.dataset.docid;
                inp.value = closestNum;
                if (docId) localStorage.setItem('pdf_page_' + docId, closestNum);
            }
        }

        const url = "{% url 'api_secure_pdf' document.id %}";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const loadingTask = pdfjsLib.getDocument({
            url: url,
            httpHeaders: { 'X-PDF-Token': '{{ pdf_token }}' },
            disableRange: true,
            disableStream: true
        });

        loadingTask.promise.then(function (pdf) {
            window.pdfDocGlobal = pdf;
            document.getElementById('pageNavTotal').innerText = '/ ' + pdf.numPages;
            document.getElementById('pageNavInput').max = pdf.numPages;

            const container = document.getElementById('pdf-container');
            const spinner   = document.getElementById('pdf-loading-spinner');
            const scale     = window.devicePixelRatio > 1 ? 2.0 : 1.5;

            const docId = '{{ document.id }}';
            const savedPageStr = localStorage.getItem('pdf_page_' + docId);
            let targetPage = savedPageStr ? parseInt(savedPageStr) : 1;
            if (targetPage > pdf.numPages) targetPage = pdf.numPages;
            if (targetPage < 1) targetPage = 1;

            let teleported = false;
            let teleportCancelled = false;
            let countdownFinished = false;

            const showTeleportBadge = () => {
                if (targetPage <= 1) return;
                const badge = document.getElementById('last-read-badge');
                const text = document.getElementById('last-read-text');
                const restoreBtn = document.getElementById('restore-teleport');
                const dismissBtn = document.getElementById('dismiss-teleport');
                
                if (badge && text && restoreBtn && dismissBtn) {
                    text.innerText = `RESUME AT PAGE ${targetPage}?`;
                    badge.classList.remove('opacity-0', 'translate-y-10');
                    badge.classList.add('opacity-100', 'translate-y-0');

                    restoreBtn.onclick = () => {
                        text.innerText = "TELEPORTING...";
                        restoreBtn.parentElement.classList.add('hidden'); // Hide the button group
                        checkAndExecuteTeleport(true); // Forced execution
                    };

                    dismissBtn.onclick = () => {
                        badge.classList.remove('opacity-100', 'translate-y-0');
                        badge.classList.add('opacity-0', 'translate-y-10');
                        teleportCancelled = true;
                    };
                }
            };

            const checkAndExecuteTeleport = (manualTrigger = false) => {
                if (teleported || teleportCancelled) return;
                
                const targetCanvas = document.getElementById('page-canvas-' + targetPage);
                if (targetCanvas && manualTrigger) {
                    teleported = true;
                    const badge = document.getElementById('last-read-badge');
                    const text = document.getElementById('last-read-text');
                    
                    targetCanvas.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    setTimeout(() => {
                        if (text) text.innerText = "VIEW RESTORED";
                        setTimeout(() => {
                            if (badge) {
                                badge.classList.remove('opacity-100', 'translate-y-0');
                                badge.classList.add('opacity-0', 'translate-y-10');
                            }
                        }, 2000);
                    }, 1000);
                }
            };

            let currPage = 1;
            function renderNextPage() {
                if (currPage > pdf.numPages) return;
                pdf.getPage(currPage).then(function (page) {
                    const viewport = page.getViewport({ scale: scale });
                    const canvas   = document.createElement('canvas');
                    canvas.id        = 'page-canvas-' + currPage;
                    canvas.className = 'w-full bg-white shadow-2xl rounded-sm object-contain pointer-events-none';
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width  = viewport.width;
                    context.fillStyle = 'white';
                    context.fillRect(0, 0, canvas.width, canvas.height);
                    container.appendChild(canvas);
                    if (window.currentZoom && window.currentZoom !== 100) canvas.style.width = window.currentZoom + '%';
                    
                    const renderTask = page.render({ canvasContext: context, viewport: viewport, background: 'white' });
                    renderTask.promise.then(function () {
                        if (currPage === 1) {
                            spinner.style.opacity = '0';
                            setTimeout(() => {
                                spinner.remove();
                                showTeleportBadge();
                            }, 500);
                        }
                        
                        // If we are waiting for this page, try to teleport
                        if (currPage === targetPage) {
                            checkAndExecuteTeleport();
                        }

                        currPage++;
                        renderNextPage();
                    });
                });
            }

            renderNextPage();

            // Back-to-top + page tracker on scroll
            const topBtn = document.getElementById('backToTopBtn');
            const scrollHandler = () => {
                const scrollY = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollY > 500) {
                    topBtn.classList.remove('translate-y-20', 'opacity-0');
                } else {
                    topBtn.classList.add('translate-y-20', 'opacity-0');
                }
                clearTimeout(pageScrollTimer);
                pageScrollTimer = setTimeout(updateCurrentPage, 50);
            };

            window.addEventListener('scroll', scrollHandler, { passive: true });
            document.addEventListener('scroll', scrollHandler, { passive: true });
            // Initial check
            updateCurrentPage();

        }, function (reason) {
            console.error('PDF Failed to Load:', reason);
            document.getElementById('pdf-loading-spinner').innerHTML =
                `<p class="text-red-500 font-bold p-6 text-center">Document secure decoupling failed:<br><span class="text-sm opacity-75">${reason}</span></p>`;
        });
    });
</script>
